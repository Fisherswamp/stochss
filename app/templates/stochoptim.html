{% extends "base.html" %}
{% block title%}Manage Simulations{% endblock %}
{% block csscontent %}{% endblock %}
{% block content %}

<div class="span9">
    <div class="row-fluid">
        <div id="stochoptim">
            Loading model content...
        </div>
    </div>
</div>
{% endblock %}

{% block jscontent %}
<script type="text/javascript" src = "/static/js/underscore.js"></script>
<script type="text/javascript" src = "/static/utils.js"></script>
<script type="text/javascript" src = "/static/js/backbone.js"></script>
<script type="text/javascript" src = "/static/model/stochkit.js"></script>
<link rel="stylesheet" href="/static/css/nv.d3.css">

<script type="text/javascript" src = "/static/js/purl.js"></script>
<script src="/static/js/jfu/js/jquery.iframe-transport.js"></script>
<script src="/static/js/jfu/js/jquery.fileupload.js"></script>
<script type="text/javascript" src = "/static/js/stochoptim.js"></script>

<script id="modelSelectTemplate" type="text/template">
    <div id="modelSelect">
        <div class="well">
            <% if(typeof models != 'undefined' ) { %>
            <h3> Select model to simulate </h3>
            <br />
            <% for(var model in models) { %>
            <label class="radio">
                <input type="radio" name="model_to_simulate" value="<%= models[model].attributes.id %>" checked /><%= models[model].attributes.name %>
                <br />
            </label>
            <% } %>
            <br />
            <button id="next" type="submit" class="btn-primary btn-large">Next&raquo;</button>
            <% } else { %>
            <h2>There are no models in the system</h2><br />
            <a style="font-size:18px;" href="/modeleditor"> Create a new model? </a>
            <% } %>
        </div>
    </div>
</script>

<script id="simulationConfTemplate" type="text/template">
    <div class="well well-large">
        <h2>
            <a data-toggle="modal" href="#help_modal1" style="text-decoration: none">Run Parameter Estimation <i class="icon-question-sign"></i> </a>
            
            <!--{% set help_modal_id = "help_modal1" %}
            {% set help_modal_title = "Stochoptim" %}
            {% set help_modal_message = "The StochOptim parameter estimation tool attemps to combine A) existing time series trajectory data with B) a model to estimate the parameters of that model. In this implementation, the model must be mass action." %}
            {% include "help_modal.html" %}
            {{help_modal|safe}}-->
            
        </h2>

        Model Name: <h2><%= attributes.name %></h2>
        Units: <h3><%= attributes.units %></h3>
        <hr />
        <label>Name:</label>
        <input type="text" class="span3" id="jobName" value="<%= attributes.name %>_job" />
        
        <span class="help-block">This name will be used to reference the estimation.</span>
        <br />
        
        <!--List of valid datafiles to include-->
        <br />

        <div id="csvSelectDiv" style="display: none;">
            1. Select csv file with trajectories:
            <br />
            <br />
            <input id="fileupload" type="file" name="files[]" multiple>
            <div id="progresses"></div>
            <!-- The global progress bar -->

            <div id="msg"></div>

            <div id="csvSeeDiv" style="display: none;">
                <br />

                2. List of CSV data files:
                <table cellpadding="0" cellspacing="0" border="0" class="table table-striped table-bordered">
                    <thead>
                        <tr>
                            <th width="40pt"></th>
                            <th width="40pt">Select</th>
                            <th>Archive Name</th>
                        </tr>
                    </thead>
                    <tbody id="csvSelect">
                    </tbody>
                </table>

                <br />

                3. CSV Preview: <br />
                <div id="preview"></div>

                <br />

                4. Select members of the archive to import:
                
                <br />

            <div id="msg"></div>
                <button class="btn-primary btn-large" id="import">Import</button>
            </div>			    

            <br />
            
            <form action="/export" method="post">
                <fieldset>
                </fieldset>
            </form>
        </div>

        <h3 class="advanced-settings">
            <a data-toggle="collapse" data-target="#advanced-settings">
                Advanced settings&raquo;
            </a>
        </h3>
        
        <div id="advanced-settings" class="collapse advanced-settings">
            <table border = "0">
                <!--<tr class="optional">
                    <td>
                        Select events file:<br />
                        <input class = "fileloader" id = "events_file" type = "file" /><br />
                    </td>
                </tr>-->
                <tr class="optional">
                    <td>
                        Steps
                        Cross Entropy: <input id = "cross_entropy_step" type = "checkbox" checked /><br />
                        EM: <input id = "em_step" type = "checkbox" checked /><br />
                        Uncertainty: <input id = "uncertainty_step" type = "checkbox" checked /><br />
                    </td>
                </tr>
                <tr class="optional">
                    <td>
                        Seed -- Random number generator seed:<br />
                        <input id= "seed" type = "number" step = "1" value = "1" /><br />
                    </td>
                </tr>
                <tr class="optional">
                    <td>
                        Kce -- Number of modified cross-entropy method trajectories to simulate:<br />
                        <input id= "Kce" type="number" value="1000" step="1" /><br />
                    </td>
                </tr>
                <tr class="optional">
                    <td>
                        Kem -- Initial number of MCEM trajectories to simulate<br />
                        <input id= "Kem" type="number" value="100" /><br />
                    </td>
                </tr>
                <tr class="optional">
                    <td>
                        Klik -- Minimum number of trajectories for estimating data likelihood:<br />
                        <input id= "Klik" type="number" value="1e4" /><br />
                    </td>
                </tr>
                <tr class="optional">
                    <td>
                        Kcov -- Minimum number of trajectories for estimating covariance matrix:<br />
                        <input id= "Kcov" type="number" value="1e4" /><br />
                    </td>
                </tr>
                <tr class="optional">
                    <td>
                        rho -- Proportion of closest trajectories to use in modified cross-entropy method:<br />
                        <input id="rho" type="number", value="0.01" /><br />
                    </td>
                </tr>
                <tr class="optional">
                    <td>
                        perturb -- Maximal fraction of uniform parameter perturbation:<br />
                        <input id="perturb" type="number" value=".25" /><br />
                    </td>
                </tr>
                <tr class="optional">
                    <td>
                        alpha -- Asymptotic error rate of expected conditional log-likelihood change (Delta Q) lower bound:<br />
                        <input id="alpha" type="number" value=".25" /><br />
                    </td>
                </tr>
                <tr class="optional">
                    <td>
                        beta -- Type II error rate for incrementing MCEM sample size:<br />
                        <input id="beta" type="number" value=".25" /><br />
                    </td>
                </tr>
                <tr class="optional">
                    <td>
                        gamma -- Asymptotic error rate of Delta Q upper bound:<br />
                        <input id="gamma" type="number" value=".25" /><br />
                    </td>
                </tr>
                <tr class="optional">
                    <td>
                        k -- Divisor of fraction for incrementing K.em<br />
                        <input id="k" type="number" step="1" value="3" /><br />
                    </td>
                </tr>
                <tr class="optional">
                    <td>
                        pcutoff -- Modified cross-entropy method convergence cutoff for mean probability of model trajectory hitting all data points:<br />
                        <input id="pcutoff" type="number" value=".05" /><br />
                    </td>
                </tr>
                <tr class="optional">
                    <td>
                        qcutoff -- MCEM convergence cutoff for Delta Q upper bound<br />
                        <input id="qcutoff" type="number" value=".005" /><br />
                    </td>
                </tr>
                <tr class="optional">
                    <td>
                        numIter -- Maximum number of uncertainty quantification iterations to run:<br />
                        <input id="numIter" type="number" step="1" value="10" /><br />
                    </td>
                </tr>
                <tr class="optional">
                    <td>
                        numConverge -- Consecutive number of Delta Q upper bound cutoff successes required for MCEM convergence:<br />
                        <input id="numConverge" type="number" value="1" /><br />
                    </td>
                </tr>
                <!--<tr class="optional">
                    <td>
                        Additional solver command line options:<br />
                        <input id="options" type="character" /><br />
                    </td>
                </tr>-->
            </table>
        </div> <!-- Advanced settings -->
      
        <div id="msg"></div>

      <button id="runLocal" type="submit" class="btn btn-primary btn-large"><i class="icon-laptop"></i> Run Locally </button>

    </div>
</script>
{% endblock %}
